<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nyota Fund — Processing Fee</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

<!-- ERROR POPUP -->
<div id="errorPopup" class="popup-overlay" style="display:none;">
  <div class="popup-card">
    <h3 style="margin:0; color:#b30000;">Verification Failed</h3>
    <p id="errorText" style="margin:10px 0; font-size:15px;"></p>
    <button id="errorCloseBtn" class="btn-cta" style="background:#b30000;">Close</button>
  </div>
</div>

<header class="header">
  <div class="navbar container">
    <div class="brand">
      <div class="logo-wrapper">
        <img src="assets/images/nyotalogo.png" alt="Nyota Fund">
      </div>
      <div>
        <div class="brand-text">Nyota Fund</div>
        <div class="brand-sub">Processing Fee</div>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="container section card">
    <h2 style="margin:0">Processing Fee Payment</h2>

    <!-- REFUND NOTE -->
    <p class="small" style="margin-top:6px;color:#0a7f2e">
      The processing fee is <strong>100% refundable</strong> if your financial eligibility is not approved.
      Refunds are returned to the same M-Pesa number within 24–48 hours.
    </p>

    <form id="feeForm" style="margin-top:16px">
      <label>Your Grant Loan Amount (KES)</label>
      <input name="amount" class="input" type="number" required min="1000" max="50000">

      <button class="btn-cta" style="margin-top:12px">Show Processing Fee</button>

      <div id="feeOutput" class="small" style="margin-top:16px"></div>

      <div id="mpesaSection" style="display:none; margin-top:20px;">
        <label>Paste Your M-Pesa Confirmation Message</label>
        <textarea
          id="mpesaMessage"
          class="input"
          rows="4"
          placeholder="e.g. TLE6713P9N Confirmed. Ksh250.00 paid to KIMTECH VENTURES..."
        ></textarea>

        <button id="nextBtn" class="btn-cta" style="margin-top:12px;" disabled>
          Next
        </button>
      </div>
    </form>
  </section>
</main>

<footer>
  <div class="container small">© Nyota Fund <span id="year-fee"></span></div>
</footer>

<script>
document.getElementById("year-fee").textContent = new Date().getFullYear();

/* ================= CONFIG ================= */
const TILL_NUMBER = "7177038";
const TILL_NAME = "KIMTECH VENTURES";
const REQUIRED_FEE = 250;

/* ================= POPUP ================= */
function showErrorPopup(message) {
  document.getElementById("errorText").textContent = message;
  document.getElementById("errorPopup").style.display = "flex";
}
document.getElementById("errorCloseBtn").onclick = () => {
  document.getElementById("errorPopup").style.display = "none";
};

/* ================= COPY ================= */
function copyTill() {
  navigator.clipboard.writeText(TILL_NUMBER);
  alert("Till number copied");
}

/* ================= SHOW FEE ================= */
document.getElementById("feeForm").addEventListener("submit", (e) => {
  e.preventDefault();

  const amount = Number(new FormData(e.target).get("amount"));
  if (amount < 1000 || amount > 50000) {
    showErrorPopup("Loan amount must be between KES 1,000 and 50,000.");
    return;
  }

  document.getElementById("feeOutput").innerHTML = `
    <strong>Loan Amount:</strong> KES ${amount.toLocaleString()}<br>
    <strong>Processing Fee:</strong>
    <span style="color:#0A84FF; font-weight:bold;">KES ${REQUIRED_FEE}</span><br><br>

    <div style="background:#f2f6ff;padding:14px;border-radius:10px;text-align:center">
      <div style="font-size:13px;opacity:.7">TILL NUMBER</div>
      <div style="font-size:24px;font-weight:bold;color:#0A84FF;user-select:all">
        ${TILL_NUMBER}
      </div>
      <button type="button" onclick="copyTill()" class="btn-cta"
        style="margin-top:10px;padding:8px 16px;font-size:14px">
        Copy Till Number
      </button>
      <div style="margin-top:8px"><strong>${TILL_NAME}</strong></div>
    </div>

    <div style="
      margin-top:14px;
      background:#e8fff1;
      border-left:4px solid #00a03d;
      padding:12px;
      border-radius:8px;
      font-size:14px;
      line-height:1.5;
    ">
      <strong>Policy:</strong><br>
      The processing fee is <strong>fully refundable</strong> if your application
      does not pass final financial eligibility verification.
      <br><br>
      Refunds are processed automatically to the same M-Pesa number within
      <strong>24–48 hours</strong>.
    </div>
  `;

  document.getElementById("mpesaSection").style.display = "block";
});

/* ================= LIVE ENABLE ================= */
document.getElementById("mpesaMessage").addEventListener("input", () => {
  document.getElementById("nextBtn").disabled =
    document.getElementById("mpesaMessage").value.trim().length < 10;
});

/* ================= NEXT CLICK VALIDATION ================= */
document.getElementById("nextBtn").addEventListener("click", (e) => {
  e.preventDefault();

  const msg = document.getElementById("mpesaMessage").value.trim().toUpperCase();

  if (!msg.includes("CONFIRMED")) {
    showErrorPopup("M-Pesa message must contain 'Confirmed'.");
    return;
  }

  if (!msg.includes(TILL_NAME)) {
    showErrorPopup("Till name does not match: " + TILL_NAME);
    return;
  }

  const amountMatch = msg.match(/KSH ?(\d+(\.\d+)?)/);
  if (!amountMatch) {
    showErrorPopup("Payment amount not found in message.");
    return;
  }

  const paid = Number(amountMatch[1]);
  if (paid !== REQUIRED_FEE) {
    showErrorPopup(
      `Incorrect amount paid. Required: Ksh ${REQUIRED_FEE}, Paid: Ksh ${paid}`
    );
    return;
  }

  // ✅ ALL GOOD
  window.location.href = "processing-details.html";
});
</script>

</body>
</html>
